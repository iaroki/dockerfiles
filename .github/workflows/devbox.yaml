---

name: "Build and push devbox"

on:
  push:
    branch: [ "master" ]
    tags: [ "*" ]
    paths:
      - "devbox/**"
      - ".github/workflows/devbox.yaml"

permissions:
  contents: "read"
  packages: "write"

env:
  IMAGE_NAME: "ghcr.io/${{ github.repository_owner }}/devbox"
  CONTEXT: "devbox"
  DOCKERFILE: "devbox/Dockerfile"

jobs:
  build:
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v3"
      - name: "Setup buildx"
        uses: "docker/setup-buildx-action@v3"
      - name: "GHCR login"
        uses: *" ]
        paths:
          - "devbox/**"
          - ".github/workflows/devbox.yaml"

    permissions:
      contents: "read"
      packages: "write"

    env:
      IMAGE_NAME: "ghcr.io/${{ github.repository_owner }}/devbox"
      CONTEXT: "devbox"
      DOCKERFILE: "devbox/Dockerfile"

    jobs:
      build:
        runs-on: "ubuntu-latest"
        steps:
          - name: "Checkout"
            uses: "actions/checkout@v3"
          - name: "Setup buildx"
            uses: "docker/setup-buildx-action@v3"
          - name: "GHCR login"
            uses: "docker/login-action@v3"
            with:
              registry: "ghcr.io"
              username: "${{ github.repository_owner }}"
              password: "${{ secrets.GITHUB_TOKEN }}"
          - name: "Timestamp generate"
            id: "vars"
            run: "echo \"date=$(date -u +'%Y%m%d-%H%M')\" >> \"$GITHUB_OUTPUT\""
          - name: "Docker metadata"
            id: "meta"
            uses: "docker/metadata-action@v5"
            with:
              images: "${{ env.IMAGE_NAME }}"
              tags: |
                type=raw,value=${{ steps.vars.outputs.date }}
                type=ref,event=tag
                type=ref,event=branch
                type=sha
                type=raw,value=latest
          - name: "Build"
            uses: "docker/build-push-action@v6"
            with:
              context: "${{ env.CONTEXT }}"
              file: "${{ env.DOCKERFILE }}"
              push: "${{ github.event_name == 'push'"
              tags: "${{ steps.meta.outputs.tags }}"
              labels: "${{ steps.meta.outputs.labels }}"
              cache-from: "type=gha"
              cache-to: "type=gha,mode=max"
